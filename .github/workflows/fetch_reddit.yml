name: ğŸŒ…ğŸŒ‡ğŸŒƒ MimicVerse Triple Harvest Cycle

on:
  schedule:
    - cron: "0 0,8,16 * * *"     # runs every 8 hours (00:00, 08:00, 16:00 UTC)
  workflow_dispatch:             # manual trigger option

permissions:
  contents: write                # allow GitHub Actions to push changes to repo

jobs:
  harvest:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸŒ€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0         # ğŸ”’ Keep your original safety â€” full history for rebase

      - name: ğŸ§  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: âš™ï¸ Install dependencies (hybrid mode)
        run: |
          echo "ğŸš€ Installing dependencies..."
          pip install --upgrade pip
          pip install --only-binary=:all: -r requirements.txt || pip install -r requirements.txt
          echo "âœ… Dependencies installed successfully."

      - name: ğŸŒ Identify Harvest Window
        id: session
        run: |
          hour=$(date -u +"%H")
          if [ $hour -lt 8 ]; then
            echo "window=ğŸŒ… Morning Harvest" >> $GITHUB_OUTPUT
          elif [ $hour -lt 16 ]; then
            echo "window=ğŸŒ‡ Midday Harvest" >> $GITHUB_OUTPUT
          else
            echo "window=ğŸŒƒ Night Harvest" >> $GITHUB_OUTPUT
          fi

      - name: ğŸŒŒ Run MimicVerse Harvester
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: MimicVerse/0.3 by u/ripped_geek
        run: |
          echo "ğŸŒ Starting ${{ steps.session.outputs.window }}..."
          python mimicverse_harvest.py || echo "âš ï¸ Harvester run failed (temporary issue or API timeout). Continuing workflow."
          echo "ğŸ§  Harvesting phase complete for ${{ steps.session.outputs.window }}!"

      - name: ğŸ“¦ Commit and push updated data (failsafe)
        run: |
          echo "ğŸ“¦ Committing harvested data..."
          git config --global user.name "MimicVerse Bot"
          git config --global user.email "bot@users.noreply.github.com"

          # ğŸ§© Preserve your original rebase + stash workflow
          git add -A
          git stash || true
          git pull --rebase --autostash || echo "âš ï¸ Pull failed, continuing with local changes..."
          git stash pop || true

          git add -A
          git status
          git commit -am "ğŸª¶ ${{ steps.session.outputs.window }} â€” $(date '+%Y-%m-%d %H:%M:%S')" || echo "âœ… No new data to commit."

          # ğŸ” Double push fallback intact
          git push || (git pull --rebase && git push) || echo "âš ï¸ Push skipped (no changes or permission issue)."

          echo "ğŸ‰ ${{ steps.session.outputs.window }} completed and committed successfully."

      - name: ğŸ§¾ Update Harvest Scroll Log
        run: |
          echo "ğŸ“œ Updating HarvestScroll.csv..."
          python harvest_logger.py || echo "âš ï¸ Logger run skipped or no changes detected."
          echo "âœ… HarvestScroll update complete."