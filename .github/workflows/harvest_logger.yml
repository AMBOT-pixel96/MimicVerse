name: ðŸ§¾ Harvest Logger (Smart Triggered Scroll)

on:
  workflow_dispatch:               # Manual run option
  push:
    paths:
      - "data/reddit_*.csv"        # Trigger only when new harvest files appear
    branches:
      - main

permissions:
  contents: write

jobs:
  log_new_harvest:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ðŸ“œ Logged new harvest')"  # prevents recursive triggers

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Detect new reddit CSVs
        id: detect
        run: |
          mkdir -p data
          echo "ðŸ”Ž Scanning data/ for reddit_*.csv..."
          ls -lt data/reddit_*.csv | head -n 5 || echo "âš ï¸ No reddit_*.csv files found."
          echo "latest_file=$(ls -t data/reddit_*.csv | head -1)" >> $GITHUB_OUTPUT

      - name: âœï¸ Append new file to HarvestScroll.csv
        run: |
          mkdir -p data
          FILE_NAME=$(basename "${{ steps.detect.outputs.latest_file }}")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S')
          POSTS=$(awk -F',' 'END{print NR-1}' "${{ steps.detect.outputs.latest_file }}")
          SUBS=$(awk -F',' 'NR>1 {print $1}' "${{ steps.detect.outputs.latest_file }}" | sort | uniq | wc -l)
          ENTRY=",$FILE_NAME,$TIMESTAMP,$POSTS,$SUBS,auto"

          if [ ! -f data/HarvestScroll.csv ]; then
            echo "seq_id,file_name,timestamp_utc,posts,subreddits,harvester_type" > data/HarvestScroll.csv
            echo "1${ENTRY}" >> data/HarvestScroll.csv
            echo "ðŸ†• Created new HarvestScroll.csv"
          else
            LAST_SEQ=$(tail -n 1 data/HarvestScroll.csv | cut -d',' -f1)
            NEXT_SEQ=$((LAST_SEQ + 1))
            echo "${NEXT_SEQ}${ENTRY}" >> data/HarvestScroll.csv
            echo "âœ… Appended new entry to HarvestScroll.csv"
          fi

      - name: ðŸš€ Commit and push update
        run: |
          git config user.name "MimicVerse Bot"
          git config user.email "bot@users.noreply.github.com"
          git add data/HarvestScroll.csv
          git commit -m "ðŸ“œ Logged new harvest in HarvestScroll.csv"
          git push