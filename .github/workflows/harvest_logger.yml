name: ðŸ§¾ Harvest Scroll Indexer

on:
  workflow_dispatch:      # can be triggered manually or from other workflows
  workflow_run:
    workflows: ["ðŸŒ™ MimicVerse Nightly Harvest"]
    types: [completed]

permissions:
  contents: write

jobs:
  update-log:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pandas
        run: pip install pandas

      - name: Update Harvest Scroll Log
        run: |
          echo "ðŸ“œ Updating HarvestScroll.csv ..."
          python - <<'PYCODE'
          import os, glob, pandas as pd, datetime
          data_dir = "data"
          os.makedirs(data_dir, exist_ok=True)
          scroll_path = os.path.join(data_dir, "HarvestScroll.csv")

          csv_files = sorted(glob.glob(f"{data_dir}/reddit_*.csv"))
          if not csv_files:
              print("âš ï¸ No harvest data found.")
              raise SystemExit

          # get the newest file
          latest_file = csv_files[-1]
          file_stat = os.stat(latest_file)
          ts = datetime.datetime.utcfromtimestamp(file_stat.st_mtime)

          # basic meta detection
          df = pd.read_csv(latest_file)
          posts = len(df)
          subs = len(df["subreddit"].unique()) if "subreddit" in df.columns else 0

          new_row = {
              "seq_id": len(pd.read_csv(scroll_path)) + 1 if os.path.exists(scroll_path) else 1,
              "file_name": os.path.basename(latest_file),
              "timestamp_utc": ts.strftime("%Y-%m-%d %H:%M:%S"),
              "posts": posts,
              "subreddits": subs,
              "harvester_type": "auto"
          }

          df_scroll = pd.read_csv(scroll_path) if os.path.exists(scroll_path) else pd.DataFrame()
          df_scroll = pd.concat([df_scroll, pd.DataFrame([new_row])], ignore_index=True)
          df_scroll.to_csv(scroll_path, index=False)
          print(f"âœ… HarvestScroll updated -> {scroll_path}")
          PYCODE

      - name: Commit and Push Scroll
        run: |
          git config user.name "MimicVerse Bot"
          git config user.email "bot@users.noreply.github.com"
          git add data/HarvestScroll.csv
          git commit -m "ðŸ“œ Updated HarvestScroll log" || echo "âœ… No changes to log"
          git push